version: '3.8'

# FindSpot Smart Parking System
# Optimized for Raspberry Pi 5 deployment

services:
  # Backend API
  flask-backend:
    build:
      context: ./findspot-backend/flask
      dockerfile: Dockerfile
    container_name: findspot-backend
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=sqlite:///data/findspot.db
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=1883
      - MQTT_USER=flask_backend
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - FLASK_ENV=production
      - HOST=0.0.0.0
      - PORT=5000
      - PYTHONUNBUFFERED=1
      - PYTHONIOENCODING=utf-8
    volumes:
      - ./findspot-backend/flask:/app
      - backend-data:/app/data
      - ./findspot-backend/.env:/.env:ro
    depends_on:
      - mqtt-broker
    networks:
      - app-network
    # Raspberry Pi 5 resource limits
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # MQTT Broker
  mqtt-broker:
    image: eclipse-mosquitto:2
    container_name: findspot-mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./findspot-backend/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./findspot-backend/mosquitto/passwd:/mosquitto/config/passwd:ro
      - mqtt-data:/mosquitto/data
      - mqtt-logs:/mosquitto/log
    networks:
      - app-network
    # Raspberry Pi 5 resource limits
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  # Frontend
  frontend:
    build:
      context: ./findspot-frontend
      dockerfile: Dockerfile
    container_name: findspot-frontend
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./findspot-frontend/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - flask-backend
    networks:
      - app-network
    # Raspberry Pi 5 resource limits
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

volumes:
  backend-data:
    driver: local
  mqtt-data:
    driver: local
  mqtt-logs:
    driver: local

networks:
  app-network:
    driver: bridge